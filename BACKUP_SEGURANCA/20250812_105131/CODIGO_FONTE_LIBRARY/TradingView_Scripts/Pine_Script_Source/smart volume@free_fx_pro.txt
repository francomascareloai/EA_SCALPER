//@version=5
indicator("Smart Volume Oscillator & Signals v1.1", shorttitle="SVO Sig", format=format.volume, timeframe="")

// --- Inputs ---
int volMaLength = input.int(20, title="Volume MA Length")
float volSpikeMultiplier = input.float(2.0, title="Volume Spike Multiplier (vs MA)") 
int priceActionConfirmBars = input.int(1, title="Price Action Confirmation Bars") 
int rsiLength = input.int(14, title="RSI Length for Confirmation")
float rsiOversold = input.float(30, "RSI Oversold Level")
float rsiOverbought = input.float(70, "RSI Overbought Level")
int emaTrendLength = input.int(50, title="EMA Trend Filter Length")
bool usePaConfirm = input.bool(true, "Use Price Action Confirmation")
bool useRsiConfirm = input.bool(true, "Use RSI Confirmation")
bool useEmaFilter = input.bool(true, "Use EMA Trend Filter")

// --- Calculations ---
float avgVolume = ta.sma(volume, volMaLength)
float volumeRatio = volume / avgVolume 

float rsi = ta.rsi(close, rsiLength)
float emaTrend = ta.ema(close, emaTrendLength)

// --- Kondisi Volume Anomali ---
bool isVolSpike = volume > avgVolume * volSpikeMultiplier
bool isLowVolume = volume < avgVolume * 0.6 

bool isUpBar = close > open
bool isDownBar = close < open
float barRange = high - low
float bodySize = math.abs(close - open)

bool bullishExhaustionVol = isVolSpike and isDownBar and barRange > ta.atr(14) * 0.8
bool bearishExhaustionVol = isVolSpike and isUpBar and barRange > ta.atr(14) * 0.8

bool noDemandVol = isUpBar and isLowVolume and high >= high[1] 
bool noSupplyVol = isDownBar and isLowVolume and low <= low[1] 

// --- Pewarnaan Bar Oscillator ---
color volColor = color.gray
if (bullishExhaustionVol)
    volColor := color.new(color.green, 40)
else if (bearishExhaustionVol)
    volColor := color.new(color.red, 40)
else if (noDemandVol)
    volColor := color.new(color.maroon, 40) // Warna untuk No Demand bisa disesuaikan
else if (noSupplyVol)
    volColor := color.new(color.lime, 40)   // Warna untuk No Supply bisa disesuaikan
else if (isVolSpike and isUpBar)
    volColor := color.new(color.green, 70)
else if (isVolSpike and isDownBar)
    volColor := color.new(color.red, 70)
else if (isUpBar)
    volColor := color.new(color.teal, 80)
else if (isDownBar)
    volColor := color.new(color.fuchsia, 80)


// --- Logika Sinyal dengan Konfirmasi ---
bool buySignalCondition = false
bool sellSignalCondition = false

// Sinyal dari Bullish Exhaustion Volume
// Kondisi anomali (misal bullishExhaustionVol) terdeteksi pada bar saat ini (bar_index)
// Konfirmasi PA dan RSI dicek pada bar saat ini, merujuk pada data bar sebelumnya [1] jika perlu (untuk PA)
// atau data RSI bar sebelumnya [1] dibandingkan RSI bar saat ini (untuk perubahan RSI)
if bullishExhaustionVol[1] // Jika anomali terjadi pada BAR SEBELUMNYA
    // Konfirmasi Price Action: close candle SAAT INI di atas high candle exhaustion (candle SEBELUMNYA)
    bool paConfirmBuy = not usePaConfirm or close > high[1] 
    // Konfirmasi RSI: RSI SEBELUMNYA oversold dan RSI SAAT INI naik, ATAU RSI SAAT INI sudah di atas oversold+5
    bool rsiConfirmBuy = not useRsiConfirm or (rsi[1] < rsiOversold and rsi > rsi[1]) or (rsi > rsiOversold + 5)
    // Filter Tren EMA
    bool emaFilterBuy = not useEmaFilter or close > emaTrend

    if paConfirmBuy and rsiConfirmBuy and emaFilterBuy
        buySignalCondition := true

// Sinyal dari No Supply Volume
if noSupplyVol[1] // Jika anomali terjadi pada BAR SEBELUMNYA
    bool paConfirmNoSupply = not usePaConfirm or close > high[1] 
    bool rsiConfirmNoSupply = not useRsiConfirm or rsi > 40 
    bool emaFilterNoSupply = not useEmaFilter or close > emaTrend

    if paConfirmNoSupply and rsiConfirmNoSupply and emaFilterNoSupply
        buySignalCondition := true


// Sinyal dari Bearish Exhaustion Volume
if bearishExhaustionVol[1] // Jika anomali terjadi pada BAR SEBELUMNYA
    bool paConfirmSell = not usePaConfirm or close < low[1]
    bool rsiConfirmSell = not useRsiConfirm or (rsi[1] > rsiOverbought and rsi < rsi[1]) or (rsi < rsiOverbought - 5)
    bool emaFilterSell = not useEmaFilter or close < emaTrend
    
    if paConfirmSell and rsiConfirmSell and emaFilterSell
        sellSignalCondition := true

// Sinyal dari No Demand Volume
if noDemandVol[1] // Jika anomali terjadi pada BAR SEBELUMNYA
    bool paConfirmNoDemand = not usePaConfirm or close < low[1]
    bool rsiConfirmNoDemand = not useRsiConfirm or rsi < 60 
    bool emaFilterNoDemand = not useEmaFilter or close < emaTrend

    if paConfirmNoDemand and rsiConfirmNoDemand and emaFilterNoDemand
        sellSignalCondition := true


// --- Plotting ---
plot(volumeRatio, title="Volume Ratio", style=plot.style_histogram, color=volColor)
hline(1, "Avg Vol Line", color.gray, linestyle=hline.style_dashed)
hline(volSpikeMultiplier, "Spike Threshold", color.orange, linestyle=hline.style_dotted)

plotshape(buySignalCondition, title="Buy Signal", location=location.belowbar, color=color.new(color.green, 0), style=shape.labelup, text="BUY", textcolor=color.white, size=size.small)
plotshape(sellSignalCondition, title="Sell Signal", location=location.abovebar, color=color.new(color.red, 0), style=shape.labeldown, text="SELL", textcolor=color.white, size=size.small)