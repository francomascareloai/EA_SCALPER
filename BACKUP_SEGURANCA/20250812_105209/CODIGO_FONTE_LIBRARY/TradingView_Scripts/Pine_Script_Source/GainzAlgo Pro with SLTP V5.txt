// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// @ azaritrader


//@version=5
indicator("GainzAlgo Pro with SL/TP", overlay=true)

// Inputs
candle_stability_index_param = input.float(0.5, title="Candle Stability Index", minval=0, maxval=1, step=0.1, group="Technical")
rsi_index_param = input.int(50, title="RSI Index", minval=0, maxval=100, group="Technical")
candle_delta_length_param = input.int(5, title="Candle Delta Length", minval=3, group="Technical")
disable_repeating_signals_param = input.bool(false, title="Disable Repeating Signals", group="Technical")
sl_multiplier = input.float(1.5, title="Stop Loss Multiplier", minval=1, maxval=5, step=0.1, group="SL/TP")
tp_multiplier = input.float(2, title="Take Profit Multiplier", minval=1, maxval=5, step=0.1, group="SL/TP")

// Colors
GREEN = color.rgb(29, 255, 40)
RED = color.rgb(255, 0, 0)
TRANSPARENT = color.new(color.rgb(0, 0, 0), 100)

// Label settings
label_size = input.string("normal", title="Label Size", options=["huge", "large", "normal", "small", "tiny"], group="Cosmetic")
label_style = input.string("text bubble", title="Label Style", options=["text bubble", "triangle", "arrow"], group="Cosmetic")
buy_label_color = input.color(GREEN, title="BUY Label Color", inline="Highlight", group="Cosmetic")
sell_label_color = input.color(RED, title="SELL Label Color", inline="Highlight", group="Cosmetic")
label_text_color = input.color(color.white, title="Label Text Color", inline="Highlight", group="Cosmetic")

// Calculations
stable_candle = math.abs(close - open) / math.max(high - low, 1e-10) > candle_stability_index_param
rsi = ta.rsi(close, 14)
bullish_engulfing = close[1] < open[1] and close > open and close > open[1]
rsi_below = rsi < rsi_index_param
decrease_over = close < close[candle_delta_length_param]
bull = bullish_engulfing and stable_candle and rsi_below and decrease_over and bar_index > candle_delta_length_param

bearish_engulfing = close[1] > open[1] and close < open and close < open[1]
rsi_above = rsi > (100 - rsi_index_param)
increase_over = close > close[candle_delta_length_param]
bear = bearish_engulfing and stable_candle and rsi_above and increase_over and bar_index > candle_delta_length_param

// SL/TP calculations
sl_price = 0.0
tp_price = 0.0
if bull
    sl_price := low - (sl_multiplier * (high - low))
    tp_price := low + (tp_multiplier * (high - low))
if bear
    sl_price := high + (sl_multiplier * (high - low))
    tp_price := high - (tp_multiplier * (high - low))

// Plot labels
var string last_signal = ""
if bull and (not disable_repeating_signals_param or last_signal != "buy")
    if label_style == "text bubble"
        label.new(bar_index, low, "BUY", style=label.style_label_up, color=buy_label_color, textcolor=label_text_color, size=label_size)
    else if label_style == "triangle"
        label.new(bar_index, low, "BUY", style=label.style_triangleup, yloc=yloc.belowbar, color=buy_label_color, textcolor=TRANSPARENT, size=label_size)
    else if label_style == "arrow"
        label.new(bar_index, low, "BUY", style=label.style_arrowup, yloc=yloc.belowbar, color=buy_label_color, textcolor=TRANSPARENT, size=label_size)
    last_signal := "buy"

if bear and (not disable_repeating_signals_param or last_signal != "sell")
    if label_style == "text bubble"
        label.new(bar_index, high, "SELL", style=label.style_label_down, color=sell_label_color, textcolor=label_text_color, size=label_size)
    else if label_style == "triangle"
        label.new(bar_index, high, "SELL", style=label.style_triangledown, yloc=yloc.abovebar, color=sell_label_color, textcolor=TRANSPARENT, size=label_size)
    else if label_style == "arrow"
        label.new(bar_index, high, "SELL", style=label.style_arrowdown, yloc=yloc.abovebar, color=sell_label_color, textcolor=TRANSPARENT, size=label_size)
    last_signal := "sell"

// // Fix: Ensure SL and TP prices are plotted for debugging
// plot(sl_price, color=color.red, linewidth=2, title="Stop Loss")
// plot(tp_price, color=color.green, linewidth=2, title="Take Profit")
