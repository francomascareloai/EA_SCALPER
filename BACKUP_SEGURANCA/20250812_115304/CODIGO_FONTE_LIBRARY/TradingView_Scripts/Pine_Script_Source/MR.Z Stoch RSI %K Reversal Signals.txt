//@version=6
indicator("MR.Z Stoch RSI %K Reversal Signals", overlay=false)

// === Inputs ===
lengthRSI     = input.int(14, "RSI Length")
lengthStoch   = input.int(14, "Stochastic Length")
smoothK       = input.int(3, "Smooth K")
peakWindow    = input.int(5, "Peak/Valley Lookback", minval=1)

kBuyMax       = input.int(30, "K Buy Max Threshold (Oversold)", minval=0, maxval=100)
kSellMin      = input.int(70, "K Sell Min Threshold (Overbought)", minval=0, maxval=100)
useSellThreshold = input.bool(true, "Use K Sell Threshold?")
requireSlopeFilter = input.bool(true, "Require Directional Slope Filter?")
showDebug     = input.bool(true, "Show Debug Markers")

// === Stoch RSI %K Calculation ===
rsiVal = ta.rsi(close, lengthRSI)
stochRSI = (rsiVal - ta.lowest(rsiVal, lengthStoch)) / (ta.highest(rsiVal, lengthStoch) - ta.lowest(rsiVal, lengthStoch))
k = ta.sma(stochRSI, smoothK) * 100

// === Relaxed Local Peak/Valley Detection (with >=)
isLocalPeak(src, len) =>
    peak = true
    for i = 1 to len
        peak := peak and src[len] >= src[len - i] and src[len] >= src[len + i]
    peak

isLocalValley(src, len) =>
    valley = true
    for i = 1 to len
        valley := valley and src[len] <= src[len - i] and src[len] <= src[len + i]
    valley

offset = peakWindow
truePeak   = isLocalPeak(k, peakWindow)
trueValley = isLocalValley(k, peakWindow)

// === Optional slope filter
slopeDown = k[peakWindow] > k[peakWindow + 1]
slopeUp   = k[peakWindow] < k[peakWindow + 1]

kPeak   = truePeak and (not useSellThreshold or k[peakWindow] >= kSellMin) and (not requireSlopeFilter or slopeDown)
kValley = trueValley and k[peakWindow] <= kBuyMax and (not requireSlopeFilter or slopeUp)

// === Plot Signals (at actual %K value)
plotshape(kPeak   ? k[peakWindow] : na, location=location.absolute, style=shape.triangledown, color=color.red,   size=size.small, offset=-peakWindow)
plotshape(kValley ? k[peakWindow] : na, location=location.absolute, style=shape.triangleup,   color=color.green, size=size.small, offset=-peakWindow)


// === Debug Markers for Rejected Signals
plotshape(showDebug and truePeak and not kPeak ? k[peakWindow] : na, location=location.absolute, style=shape.xcross, color=color.gray, size=size.tiny, offset=-peakWindow)
plotshape(showDebug and trueValley and not kValley ? k[peakWindow] : na, location=location.absolute, style=shape.xcross, color=color.gray, size=size.tiny, offset=-peakWindow)

// === Plot %K and thresholds
plot(k, "K", color=color.green)
hline(kBuyMax,  "K Buy Threshold",  color=color.new(color.green, 60), linestyle=hline.style_dashed)
hline(kSellMin, "K Sell Threshold", color=color.new(color.red, 60),   linestyle=hline.style_dashed)

// === Alerts
alertcondition(kPeak, title="SELL Alert", message="SELL Signal: %K formed a valid peak on {{ticker}}")
alertcondition(kValley, title="BUY Alert", message="BUY Signal: %K formed a valid valley on {{ticker}}")
// === Dotted lines from 0 to 100 ===
hline(0,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(1,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(2,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(3,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(4,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(5,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(6,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(7,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(8,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(9,  "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(10, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(11, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(12, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(13, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(14, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(15, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(16, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(17, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(18, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(19, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(20, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(21, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(22, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(23, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(24, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(25, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(26, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(27, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(28, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(29, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(30, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(31, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(32, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(33, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(34, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(35, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(36, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(37, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(38, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(39, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(40, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(41, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(42, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(43, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(44, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(45, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(46, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(47, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(48, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(49, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(50, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(51, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(52, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(53, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(54, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(55, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(56, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(57, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(58, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(59, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(60, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(61, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(62, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(63, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(64, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(65, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(66, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(67, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(68, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(69, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(70, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(71, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(72, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(73, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(74, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(75, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(76, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(77, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(78, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(79, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(80, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(81, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(82, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(83, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(84, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(85, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(86, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(87, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(88, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(89, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(90, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(91, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(92, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(93, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(94, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(95, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(96, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(97, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(98, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(99, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(100, "", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
// === Highlight 0 and 100 levels
hline(0,   "0 Level",   color=color.white, linestyle=hline.style_solid, linewidth=2)
hline(100, "100 Level", color=color.white, linestyle=hline.style_solid, linewidth=2)
