//@version=5 
indicator("Key levels by Leo", overlay=true)

//Explanation in english:

//- Buy order: when the candle closes above the GREEN line, enter into long operations (Buy)
//- Sell order: when the candle closes below the RED line, enter into short operations (Sell)
//- Take Profit: For long trades, target the next RED line above. For short trades, target the next GREEN line below.
//- Stop Loss: For long trades, set the stop loss at the RED line below. For short trades, set it at the GREEN line above.
//- Timeframe: 15m

//Explicación en español:

//- Orden de compra: cuando la vela cierre por arriba de la línea VERDE entre en operaciones largas (Buy)
//- Orden venta: cuando la vela cierre por debajo de la línea ROJA entre en operaciones cortas (Sell)
//- Take Profit: para operaciones largas, apunta a la siguiente línea ROJA que aparece arriba. Para operaciones cortas, apunta a la siguiente línea VERDE que aparece abajo.
//- Stop Loss: para operaciones largas, establece el stop loss en la línea ROJA que aparece abajo. Para operaciones cortas, configúralo en la línea VERDE que aparece arriba.
//- Temporalidad: 15m

// Entrada para ajustar el desplazamiento del índice de barras
desplazamiento_barras = input.int(50, title="Bar displacement", minval=1)

// Detectar el inicio de un nuevo día
nueva_vela_dia = ta.change(time("1D"))

// Variables para almacenar el high y low de la primera vela del día actual
var float high_primera_vela = na
var float low_primera_vela = na

if (nueva_vela_dia)
    // Guardar el high y low de la primera vela del día actual
    high_primera_vela := high
    low_primera_vela := low

// Calcular el promedio del high y low de la primera vela del día
float promedio_primera_vela = na
if (not na(high_primera_vela) and not na(low_primera_vela))
    promedio_primera_vela := (high_primera_vela + low_primera_vela) / 2

// Calcular las nuevas variables basadas en el promedio
float promedio_mas_ajuste = na
float promedio_menos_ajuste = na
if (not na(promedio_primera_vela))
    promedio_mas_ajuste := promedio_primera_vela + 0.864
    promedio_menos_ajuste := promedio_primera_vela - 0.864

// Calcular bl1 y bh1
float bl1 = na
float bh1 = na
if (not na(promedio_mas_ajuste)) 
    bl1 := promedio_mas_ajuste + 4.331
    bh1 := bl1 + 1.737

// Calcular bl2 y bh2
float bl2 = na
float bh2 = na
if (not na(bh1))
    bl2 := bh1 + 4.352
    bh2 := bl2 + 1.745

// Calcular bl3 y bh3
float bl3 = na
float bh3 = na
if (not na(bh2))
    bl3 := bh2 + 4.374
    bh3 := bl3 + 1.754

// Calcular bl4 y bh4
float bl4 = na
float bh4 = na
if (not na(bh3))
    bl4 := bh3 + 4.395
    bh4 := bl4 + 1.762

// Calcular bl5 y bh5
float bl5 = na
float bh5 = na
if (not na(bh4))
    bl5 := bh4 + 4.417
    bh5 := bl5 + 1.771

// Calcular sh1 y sl1
float sh1 = na
float sl1 = na
if (not na(promedio_menos_ajuste))
    sh1 := promedio_menos_ajuste - 4.313
    sl1 := sh1 - 1.721

// Calcular sh2 y sl2
float sh2 = na
float sl2 = na
if (not na(sl1))
    sh2 := sl1 - 4.291
    sl2 := sh2 - 1.713

// Calcular sh3 y sl3
float sh3 = na
float sl3 = na
if (not na(sl2))
    sh3 := sl2 - 4.27
    sl3 := sh3 - 1.704

// Calcular sh4 y sl4
float sh4 = na
float sl4 = na
if (not na(sl3))
    sh4 := sl3 - 4.248
    sl4 := sh4 - 1.696

// Calcular sh5 y sl5
float sh5 = na
float sl5 = na
if (not na(sl4))
    sh5 := sl4 - 4.227
    sl5 := sh5 - 1.687
// Variables para controlar si ya se mostraron los labels del día
var label high_label = na
var label low_label = na
var label promedio_label = na
var label promedio_mas_label = na
var label promedio_menos_label = na
var label bl1_label = na
var label bh1_label = na
var label bl2_label = na
var label bh2_label = na
var label bl3_label = na
var label bh3_label = na
var label bl4_label = na
var label bh4_label = na
var label bl5_label = na
var label bh5_label = na
var label sh1_label = na
var label sl1_label = na
var label sh2_label = na
var label sl2_label = na
var label sh3_label = na
var label sl3_label = na
var label sh4_label = na
var label sl4_label = na
var label sh5_label = na
var label sl5_label = na

// Eliminar los labels del día anterior al inicio de un nuevo día
if (nueva_vela_dia)
    if (not na(high_label))
        label.delete(high_label)
    if (not na(low_label))
        label.delete(low_label)
    if (not na(promedio_label))
        label.delete(promedio_label)
    if (not na(promedio_mas_label))
        label.delete(promedio_mas_label)
    if (not na(promedio_menos_label))
        label.delete(promedio_menos_label)
    if (not na(bl1_label))
        label.delete(bl1_label)
    if (not na(bh1_label))
        label.delete(bh1_label)
    if (not na(bl2_label))
        label.delete(bl2_label)
    if (not na(bh2_label))
        label.delete(bh2_label)
    if (not na(bl3_label))
        label.delete(bl3_label)
    if (not na(bh3_label))
        label.delete(bh3_label)
    if (not na(bl4_label))
        label.delete(bl4_label)
    if (not na(bh4_label))
        label.delete(bh4_label)
    if (not na(bl5_label))
        label.delete(bl5_label)
    if (not na(bh5_label))
        label.delete(bh5_label)
    if (not na(sh1_label))
        label.delete(sh1_label)
    if (not na(sl1_label))
        label.delete(sl1_label)
    if (not na(sh2_label))
        label.delete(sh2_label)
    if (not na(sl2_label))
        label.delete(sl2_label)
    if (not na(sh3_label))
        label.delete(sh3_label)
    if (not na(sl3_label))
        label.delete(sl3_label)
    if (not na(sh4_label))
        label.delete(sh4_label)
    if (not na(sl4_label))
        label.delete(sl4_label)
    if (not na(sh5_label))
        label.delete(sh5_label)
    if (not na(sl5_label))
        label.delete(sl5_label)
		
    // Crear nuevos labels solo una vez al comienzo del día
    promedio_mas_label := label.new(bar_index + desplazamiento_barras, promedio_mas_ajuste, "↓ " + str.tostring(promedio_mas_ajuste), color=#9b27b000, textcolor=color.green, style=label.style_label_down)
    promedio_menos_label := label.new(bar_index + desplazamiento_barras, promedio_menos_ajuste,str.tostring(promedio_menos_ajuste) + " ↑", color=#ff990000, textcolor=color.red, style=label.style_label_up)
    bl1_label := label.new(bar_index + desplazamiento_barras, bl1, str.tostring(bl1) + " ↑", color=#2195f300, textcolor=color.red, style=label.style_label_up)
    bh1_label := label.new(bar_index + desplazamiento_barras, bh1, "↓ " + str.tostring(bh1), color=#9b27b000, textcolor=color.green, style=label.style_label_down)
    bl2_label := label.new(bar_index + desplazamiento_barras, bl2,str.tostring(bl2) + " ↑", color=#2195f300, textcolor=color.red, style=label.style_label_up)
    bh2_label := label.new(bar_index + desplazamiento_barras, bh2, "↓ " + str.tostring(bh2), color=#9b27b000, textcolor=color.green, style=label.style_label_down)
    bl3_label := label.new(bar_index + desplazamiento_barras, bl3,str.tostring(bl3) + " ↑", color=#2195f300, textcolor=color.red, style=label.style_label_up)
    bh3_label := label.new(bar_index + desplazamiento_barras, bh3, "↓ " + str.tostring(bh3), color=#9b27b000, textcolor=color.green, style=label.style_label_down)
    bl4_label := label.new(bar_index + desplazamiento_barras, bl4,str.tostring(bl4) + " ↑", color=#2195f300, textcolor=color.red, style=label.style_label_up)
    bh4_label := label.new(bar_index + desplazamiento_barras, bh4, "↓ " + str.tostring(bh4), color=#9b27b000, textcolor=color.green, style=label.style_label_down)
    bl5_label := label.new(bar_index + desplazamiento_barras, bl5,str.tostring(bl5) + " ↑", color=#2195f300, textcolor=color.red, style=label.style_label_up)
    bh5_label := label.new(bar_index + desplazamiento_barras, bh5, "↓ " + str.tostring(bh5), color=#9b27b000, textcolor=color.green, style=label.style_label_down)
    sh1_label := label.new(bar_index + desplazamiento_barras, sh1, "↓ " + str.tostring(sh1), color=#2195f300, textcolor=color.green, style=label.style_label_down)
    sl1_label := label.new(bar_index + desplazamiento_barras, sl1,str.tostring(sl1)+ " ↑", color=#9b27b000, textcolor=color.red, style=label.style_label_up)
    sh2_label := label.new(bar_index + desplazamiento_barras, sh2, "↓ " + str.tostring(sh2), color=#2195f300, textcolor=color.green, style=label.style_label_down)
    sl2_label := label.new(bar_index + desplazamiento_barras, sl2,  str.tostring(sl2) + " ↑", color=#9b27b000, textcolor=color.red, style=label.style_label_up)
    sh3_label := label.new(bar_index + desplazamiento_barras, sh3, "↓ " + str.tostring(sh3), color=#2195f300, textcolor=color.green, style=label.style_label_down)
    sl3_label := label.new(bar_index + desplazamiento_barras, sl3,str.tostring(sl3)+ " ↑", color=#9b27b000, textcolor=color.red, style=label.style_label_up)
    sh4_label := label.new(bar_index + desplazamiento_barras, sh4, "↓ " + str.tostring(sh4), color=#2195f300, textcolor=color.green, style=label.style_label_down)
    sl4_label := label.new(bar_index + desplazamiento_barras, sl4,str.tostring(sl4)+ " ↑", color=#9b27b000, textcolor=color.red, style=label.style_label_up)
    sh5_label := label.new(bar_index + desplazamiento_barras, sh5, "↓ " + str.tostring(sh5), color=#2195f300, textcolor=color.green, style=label.style_label_down)
    sl5_label := label.new(bar_index + desplazamiento_barras, sl5,str.tostring(sl5)+ " ↑", color=#9b27b000, textcolor=color.red, style=label.style_label_up)

// Dibujar líneas para buy low (bl) buy high (bh) sell low (sl) sell high (sh)
if (not na(promedio_mas_ajuste))
    line.new(bar_index[1], promedio_mas_ajuste, bar_index, promedio_mas_ajuste, color=color.green, width=2, extend=extend.both)

if (not na(promedio_menos_ajuste))
    line.new(bar_index[1], promedio_menos_ajuste, bar_index, promedio_menos_ajuste, color=color.red, width=2, extend=extend.both)

if (not na(bl1))
    line.new(bar_index[1], bl1, bar_index, bl1, color=color.red, width=2, extend=extend.both)
if (not na(bh1))
    line.new(bar_index[1], bh1, bar_index, bh1, color=color.green, width=2, extend=extend.both)

if (not na(bl2))
    line.new(bar_index[1], bl2, bar_index, bl2, color=color.red, width=2, extend=extend.both)
if (not na(bh2))
    line.new(bar_index[1], bh2, bar_index, bh2, color=color.green, width=2, extend=extend.both)

if (not na(bl3))
    line.new(bar_index[1], bl3, bar_index, bl3, color=color.red, width=2, extend=extend.both)
if (not na(bh3))
    line.new(bar_index[1], bh3, bar_index, bh3, color=color.green, width=2, extend=extend.both)

if (not na(bl4))
    line.new(bar_index[1], bl4, bar_index, bl4, color=color.red, width=2, extend=extend.both)
if (not na(bh4))
    line.new(bar_index[1], bh4, bar_index, bh4, color=color.green, width=2, extend=extend.both)

if (not na(bl5))
    line.new(bar_index[1], bl5, bar_index, bl5, color=color.red, width=2, extend=extend.both)
if (not na(bh5))
    line.new(bar_index[1], bh5, bar_index, bh5, color=color.green, width=2, extend=extend.both)

if (not na(sh1))
    line.new(bar_index[1], sh1, bar_index, sh1, color=color.green, width=2, extend=extend.both)
if (not na(sl1))
    line.new(bar_index[1], sl1, bar_index, sl1, color=color.red, width=2, extend=extend.both)

if (not na(sh2))
    line.new(bar_index[1], sh2, bar_index, sh2, color=color.green, width=2, extend=extend.both)
if (not na(sl2))
    line.new(bar_index[1], sl2, bar_index, sl2, color=color.red, width=2, extend=extend.both)

if (not na(sh3))
    line.new(bar_index[1], sh3, bar_index, sh3, color=color.green, width=2, extend=extend.both)
if (not na(sl3))
    line.new(bar_index[1], sl3, bar_index, sl3, color=color.red, width=2, extend=extend.both)

if (not na(sh4))
    line.new(bar_index[1], sh4, bar_index, sh4, color=color.green, width=2, extend=extend.both)
if (not na(sl4))
    line.new(bar_index[1], sl4, bar_index, sl4, color=color.red, width=2, extend=extend.both)

if (not na(sh5))
    line.new(bar_index[1], sh5, bar_index, sh5, color=color.green, width=2, extend=extend.both)
if (not na(sl5))
    line.new(bar_index[1], sl5, bar_index, sl5, color=color.red, width=2, extend=extend.both)



