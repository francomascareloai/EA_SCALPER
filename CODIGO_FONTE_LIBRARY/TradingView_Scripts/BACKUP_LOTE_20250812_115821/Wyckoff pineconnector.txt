//@version=5
indicator("Wyckoff Spring Indicator - PineConnector", overlay=true)

// ‚û°Ô∏è Define piv type
type piv 
    float p 
    int b
    bool act = true
    int c = 0

// üìå Inputs
pivlen = input.int(6, "Pivot Length")
rangePeriod = input.int(100, "Trading Range Period")
reqVol = input.bool(false, "Require Volume Confirmation")
volThresh = input.float(1.5, "Volume Threshold")

// ‚úÖ User-defined Lot Size for PineConnector
lotSize = input.float(0.01, title="Lot Size")  // Default lot size is 0.01, changeable

// ‚úÖ Pivot Low Calculation
pl = ta.pivotlow(pivlen, pivlen)

// ‚úÖ Trading Range Low
lowRange = ta.lowest(low, rangePeriod)

// ‚úÖ Volume Confirmation
avgVol = ta.sma(volume, rangePeriod)
meetsThresh = volume >= avgVol * volThresh

// ‚û°Ô∏è Spring Confirmation Logic
var pivs = array.new<piv>()
var int tradeCounter = 0

if not na(pl)
    array.unshift(pivs, piv.new(pl, bar_index))

for p in pivs
    if p.act
        if low < p.p and close > p.p and p.c <= 3 and low <= lowRange and (reqVol ? meetsThresh : true)
            tradeCounter += 1

            // ‚úÖ Plot Buy Signal as an Arrow
            label.new(bar_index, low, "‚¨Ü", color=color.lime, textcolor=color.white, yloc=yloc.belowbar, size=size.small)

            // ‚û°Ô∏è Alert Condition
            if syminfo.ticker == "XAUUSDc"
                alert("license id,buy,XAUUSDc,risk=0.01,tp=500", alert.freq_once_per_bar_close)

            p.act := false
        else if low < p.p
            p.c += 1

// ‚úÖ Plot Pivot Low for reference
plot(pl, "Pivot Low", color=color.gray, linewidth=1)
plot(lowRange, "Range Low", color=color.blue, linewidth=1)
