//@version=5
indicator("GANN Square of 9 by LEO", overlay=true)

// Obtener la hora actual en UTC
utc_hour = hour(time)
utc_minute = minute(time)

// Convertir la hora actual a UTC-7
utc_minus_7_hour = utc_hour - 7
if (utc_minus_7_hour < 0)
    utc_minus_7_hour := utc_minus_7_hour + 24

// Determinar si es la vela de medianoche en UTC-7
is_midnight_candle = utc_minus_7_hour == 0 and utc_minute == 0

var float midnight_open = na
var float midnight_high = na
var float midnight_low = na
var float midnight_close = na

// Si es la vela de medianoche en UTC-7, almacenar los valores de OHLC
if is_midnight_candle
    midnight_open := open
    midnight_high := high
    midnight_low := low
    midnight_close := close

// Calcular la operación matemática
midnight_open_sqrt = math.sqrt(midnight_open)
operation_Resistance = math.pow(midnight_open_sqrt + 0.0625, 2)
operation_Resistance2 = math.pow(midnight_open_sqrt + 0.125, 2)
operation_Resistance3 = math.pow(midnight_open_sqrt + 0.2, 2)
operation_Resistance4 = math.pow(midnight_open_sqrt + 0.25, 2)
operation_Resistance5 = math.pow(midnight_open_sqrt + 0.375, 2)
operation_Resistance6 = math.pow(midnight_open_sqrt + 0.5, 2)
operation_Support = math.pow(midnight_open_sqrt - 0.0625, 2)
operation_Support2 = math.pow(midnight_open_sqrt - 0.125, 2)
operation_Support3 = math.pow(midnight_open_sqrt - 0.2, 2)
operation_Support4 = math.pow(midnight_open_sqrt - 0.25, 2)
operation_Support5 = math.pow(midnight_open_sqrt - 0.375, 2)
operation_Support6 = math.pow(midnight_open_sqrt - 0.5, 2)

// Determinar tamaño de las celdas
sizeOption = input.string(title="VF Text Size", 
     options=["Normal", "Small"],
     defval="Small")
     
txtSize= (sizeOption == "Small") ? size.small :  size.normal

//BUY/Sell confirmation line
// Today's Session Start timestamp
y = year(timenow)
m = month(timenow)
d = dayofmonth(timenow)

// Start & End time for 
showLineOnSameDay=input(true, title="Show VF Lines on same Day")
dd=showLineOnSameDay?d:d+1
start = timestamp(y, m, dd, 09, 15)
end = start + 86400000

// Dibujar líneas horizontales en los valores de tabla
tom_start = start
tom_end = end
colorLabl=input.color(color.black,"VF Label Text color")

var lbl3 = label.new(na, na, "T1", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl4 = label.new(na, na, "T2", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl5 = label.new(na, na, "T3", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl6 = label.new(na, na, "T4", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl7 = label.new(na, na, "T5", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl8 = label.new(na, na, "T6", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl9 = label.new(na, na, "T1", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl10 = label.new(na, na, "T2", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl11 = label.new(na, na, "T3", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl12 = label.new(na, na, "T4", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl13 = label.new(na, na, "T5", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl14 = label.new(na, na, "T6", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)
var lbl15 = label.new(na, na, "Price Start", color = color(na), style = label.style_label_left,size = txtSize, textcolor = colorLabl)


colorBuy=input.color(color.green,"Buy Above Lines color")
colorSell=input.color(color.red,"Sell Below Lines color")
colorStart=input.color(color.blue,"Buy Above, Sell Below")

var lin3 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorBuy)
var lin4 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorBuy)
var lin5 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorBuy)
var lin6 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorBuy)
var lin7 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorBuy)
var lin8 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorBuy)
var lin9 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorSell)
var lin10 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorSell)
var lin11 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorSell)
var lin12 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorSell)
var lin13 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorSell)
var lin14 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorSell)
var lin15 = line.new(na, na, na, na, xloc = xloc.bar_time, style = line.style_solid,color=colorStart,width = 2)


//T1
line.set_xy1(lin3, tom_start, operation_Resistance)
line.set_xy2(lin3, tom_end,operation_Resistance)
label.set_xy(lbl3, bar_index, operation_Resistance)
//T2
line.set_xy1(lin4, tom_start, operation_Resistance2)
line.set_xy2(lin4, tom_end,operation_Resistance2)
label.set_xy(lbl4, bar_index, operation_Resistance2)
//T3
line.set_xy1(lin5, tom_start, operation_Resistance3)
line.set_xy2(lin5, tom_end,operation_Resistance3)
label.set_xy(lbl5, bar_index, operation_Resistance3)
//T4
line.set_xy1(lin6, tom_start, operation_Resistance4)
line.set_xy2(lin6, tom_end,operation_Resistance4)
label.set_xy(lbl6, bar_index, operation_Resistance4)
//T5
line.set_xy1(lin7, tom_start, operation_Resistance5)
line.set_xy2(lin7, tom_end,operation_Resistance5)
label.set_xy(lbl7, bar_index, operation_Resistance5)
//T6
line.set_xy1(lin8, tom_start, operation_Resistance6)
line.set_xy2(lin8, tom_end,operation_Resistance6)
label.set_xy(lbl8, bar_index, operation_Resistance6)

//S1
line.set_xy1(lin9, tom_start, operation_Support)
line.set_xy2(lin9, tom_end,operation_Support)
label.set_xy(lbl9, bar_index, operation_Support)
//S2
line.set_xy1(lin10, tom_start, operation_Support2)
line.set_xy2(lin10, tom_end,operation_Support2)
label.set_xy(lbl10, bar_index, operation_Support2)
//S3
line.set_xy1(lin11, tom_start, operation_Support3)
line.set_xy2(lin11, tom_end,operation_Support3)
label.set_xy(lbl11, bar_index, operation_Support3)
//S4
line.set_xy1(lin12, tom_start, operation_Support4)
line.set_xy2(lin12, tom_end,operation_Support4)
label.set_xy(lbl12, bar_index, operation_Support4)
//S5
line.set_xy1(lin13, tom_start, operation_Support5)
line.set_xy2(lin13, tom_end,operation_Support5)
label.set_xy(lbl13, bar_index, operation_Support5)
//S6
line.set_xy1(lin14, tom_start, operation_Support6)
line.set_xy2(lin14, tom_end,operation_Support6)
label.set_xy(lbl14, bar_index, operation_Support6)

//Buy Above
line.set_xy1(lin15, tom_start, midnight_open)
line.set_xy2(lin15, tom_end,midnight_open)
label.set_xy(lbl15, bar_index, midnight_open)


// Determinar colores base
color_g=#e6fce8
coor_r=#fce6ea
color_n=#bab8b8
color_rg=#ebe6ea
color_wh=color.white

txt_color_r=#f50a19
txt_color_g=#039458

// Determinar comentarios
trendingTimes="45,67.5,90: On trending Times"
NormalTargets="22.5,36: Normal Targets"
tableToolTip="This table works well in a Trending Markets; in sideways market use it as Support and Resistance"

// Crear una tabla con los valores de la vela de medianoche y el resultado de la operación matemática
if is_midnight_candle
    var tableData = table.new(position.bottom_right,columns = 8, rows = 3, bgcolor = color.yellow, border_width = 1, border_color=color.white)
    
    table.cell(tableData, column = 0, row = 0, text = "@llopezf", bgcolor=color.white, text_size=txtSize,tooltip=tableToolTip)
    table.cell(tableData, column = 0, row = 1, text = "Resistance ", bgcolor=color.green ,text_size=txtSize)
    table.cell(tableData, column = 0, row = 2, text = "Support ", bgcolor=color.orange ,text_size=txtSize)

    table.cell(tableData, column = 1, row = 0, text = "Price " ,text_size=txtSize,tooltip="NY midnight opening candle")
    table.cell(tableData, column = 2, row = 0, text = "T1/12.5", bgcolor=color.white,text_size=txtSize)
    table.cell(tableData, column = 3, row = 0, text = "T2/22.5", bgcolor=color.gray,text_size=txtSize,tooltip=NormalTargets)
    table.cell(tableData, column = 4, row = 0, text = "T3/36", bgcolor=color.gray,text_size=txtSize,tooltip=NormalTargets)
    table.cell(tableData, column = 5, row = 0, text = "T4/45", bgcolor=color.green,text_size=txtSize,tooltip=trendingTimes)
    table.cell(tableData, column = 6, row = 0, text = "T5/67.5", bgcolor=color.green,text_size=txtSize,tooltip=trendingTimes)
    table.cell(tableData, column = 7, row = 0, text = "T6/90", bgcolor=color.green,text_size=txtSize,tooltip=trendingTimes)

    table.cell(tableData, column = 1, row = 1, text = str.tostring(midnight_open), bgcolor=color_g ,text_size=txtSize, text_color=txt_color_r)
    table.cell(tableData, column = 2, row = 1, text = str.tostring(math.round(operation_Resistance, 2)), bgcolor=color_wh,text_size=txtSize, text_color=txt_color_r)
    table.cell(tableData, column = 3, row = 1, text = str.tostring(math.round(operation_Resistance2, 2)), bgcolor=color_n,text_size=txtSize, text_color=txt_color_r)
    table.cell(tableData, column = 4, row = 1, text = str.tostring(math.round(operation_Resistance3, 2)), bgcolor=color_n,text_size=txtSize, text_color=txt_color_r)
    table.cell(tableData, column = 5, row = 1, text = str.tostring(math.round(operation_Resistance4, 2)), bgcolor=color_g,text_size=txtSize, text_color=txt_color_r)
    table.cell(tableData, column = 6, row = 1, text = str.tostring(math.round(operation_Resistance5, 2)), bgcolor=color_g,text_size=txtSize, text_color=txt_color_r)
    table.cell(tableData, column = 7, row = 1, text = str.tostring(math.round(operation_Resistance6, 2)), bgcolor=color_g,text_size=txtSize, text_color=txt_color_r)

    table.cell(tableData, column = 1, row = 2, text = str.tostring(midnight_open) , bgcolor=coor_r,text_size=txtSize,text_color=txt_color_g)
    table.cell(tableData, column = 2, row = 2, text = str.tostring(math.round(operation_Support, 2)), bgcolor=color_wh,text_size=txtSize,text_color=txt_color_g)
    table.cell(tableData, column = 3, row = 2, text = str.tostring(math.round(operation_Support2, 2)), bgcolor=color_rg,text_size=txtSize,text_color=txt_color_g)
    table.cell(tableData, column = 4, row = 2, text = str.tostring(math.round(operation_Support3, 2)), bgcolor=color_rg,text_size=txtSize,text_color=txt_color_g)
    table.cell(tableData, column = 5, row = 2, text = str.tostring(math.round(operation_Support4, 2)), bgcolor=coor_r,text_size=txtSize,text_color=txt_color_g)
    table.cell(tableData, column = 6, row = 2, text = str.tostring(math.round(operation_Support5, 2)), bgcolor=coor_r,text_size=txtSize,text_color=txt_color_g)
    table.cell(tableData, column = 7, row = 2, text = str.tostring(math.round(operation_Support6, 2)), bgcolor=coor_r,text_size=txtSize,text_color=txt_color_g)

// Mostrar una flecha roja en el gráfico para indicar la vela de medianoche en UTC-7
plotshape(series=is_midnight_candle, color=color.red, style=shape.triangleup, location=location.belowbar, size=size.small, text = "Midnight NY")

